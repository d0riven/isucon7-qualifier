## 13:00 ~ (初期設定)

* 初回ベンチマーク実行 (score : 6271)
* 監視の追加 (score : 3914~4136)
    + mackerel
    + newrelic
* gitの追加やMakefileの作成など
* nginxのunixドメインソケット化(score : 6443)
* iconsのパーミッションでこけているのを修正した.(ユニックスドメインソケットでuserを変えたために起きた）
    + sudo chown -R isucon:isucon /var/lib/nginx/fastcgi

## 15:00 ~
* newrelicを見て,/icons/*, /fetch に時間がかかっているので/iconsから直すことにした
* icons/のDBの参照に時間がかかっているのでインデックス貼った (score : 6526)
    + ユニークインデックスを貼ろうとしたら落ちた。コードを見る限り１行しか取得しておらず、違和感を覚える。
    + disk ioは減ったがインデックス貼ったが行数が少ないためかあまり効果はなかった。
    + create index name_idx ON image (name);
* icons/をキャッシュに載せるように変更 (score : 7033)
    + phpredisの導入
    + まだキャッシュのpurgeが出来てないのでいくつか落ちているので追って修正
    + この時点で負荷の殆どはfetchが支配的になる
* icons/をキャッシュに載せるように変更 (score : 7230)
    + iconが更新されたときに対象のキャッシュをパージするように修正
* /fetchではhavereadをキャッシュから取得するようにした (score : 7046)
    + message, havereadの参照にかなりの時間がかかっていた
    + havereadは初期状態が空でinsertされてない状態から始まるのでまずはここをINSERT時にするようにしてみた
    + havereadの参照される時間は短くなったが逆にmessageの参照される時間が伸びたのでスコアは下がった
## 18:00 ~
* /fetchのmessageを元に生成していた未読数をキャッシュ上に載せるようにした (score : 	10758)
    + messageのロジックを見ると未読数の生成を行っていた
    + 初回の未読数はチャンネル毎のメッセージ数をユーザ毎にキャッシュとして持たせた
    + チャンネル追加、メッセージ追加、ユーザの追加に合わせてキャッシュを追加するようにした
    + 未読数生成用のhavereadはキャッシュで完結するのでそもそも挿入しないようにした(サービスの冗長性的な意味ではやってはいけないけど、速度が大事なので気にしない）
## 19:00 ~
* DBの画像を全て静的ファイルとしてpublic/icons配下に配置してnginx側で返すようにした (score : 14036)
    + DBの負荷は下げられるだけ下げて逆にredis側がボトルネックになってきた
    + 以下のようなエラーが大量に出ていて点数が下がっているように見える。どう対処するべきか…
```
2017/10/22 14:45:36 [error] 6471#6471: *294 connect() to unix:/run/php-fpm/isubata-php7.sock failed (11: Resource temporarily unavailable) while connecting to upstream, client: 27.133.153.202, server: , request: "GET /icons/9ffcd7cee7e5947b204db47c5738150e09e685e1.png HTTP/1.1", upstream: "fastcgi://unix:/run/php-fpm/isubata-php7.sock:", host: "isubata.example.com"
2017/10/22 14:45:36 [error] 6471#6471: *470 connect() to unix:/run/php-fpm/isubata-php7.sock failed (11: Resource temporarily unavailable) while connecting to upstream, client: 27.133.153.202, server: , request: "GET /icons/65ea5a70b1fcf8f5f816b01b87f2aca2251315b0.png HTTP/1.1", upstream: "fastcgi://unix:/run/php-fpm/isubata-php7.sock:", host: "isubata.example.com"
```
* 上記のパラメータをカーネルパラメータをいじって出ないようにした (score : 11611)
    + エラーは出なくなったが静的ファイルのレスンポンスに非常に時間がかかっているのが謎
* RedisがボトルネックになりつつあったのでPredisからPhpRedisに変更した (score : 15634)
    + 未だに静的ファイルのエラーは取れず
## 20:00 ~
* サーバ再起動前に監視サービスをdisableする
    + sudo systemctl disable mackerel-agent.service
    + newrelic-daemonについては/etc/init.d/経由なのか再起動後に動作するようなことはなかった

```
0/22 20:31:15 負荷レベルが上昇しました。
10/22 20:31:16 レスポンスが遅いため負荷レベルを上げられませんでした。/message?channel_id=2&last_message_id=0
10/22 20:31:17 レスポンスが遅いため負荷レベルを上げられませんでした。/message?channel_id=2&last_message_id=0
10/22 20:31:18 レスポンスが遅いため負荷レベルを上げられませんでした。/css/main.css
10/22 20:31:19 レスポンスが遅いため負荷レベルを上げられませんでした。/fonts/glyphicons-halflings-regular.svg
10/22 20:31:20 レスポンスが遅いため負荷レベルを上げられませんでした。/icons/b4f9effc4d9e86b58b271f5652b51dd997036d43.png
10/22 20:31:21 レスポンスが遅いため負荷レベルを上げられませんでした。/fonts/glyphicons-halflings-regular.woff
10/22 20:31:22 レスポンスが遅いため負荷レベルを上げられませんでした。/fonts/glyphicons-halflings-regular.svg
10/22 20:31:23 レスポンスが遅いため負荷レベルを上げられませんでした。/js/tether.min.js
10/22 20:31:24 レスポンスが遅いため負荷レベルを上げられませんでした。/icons/3f6591acbf1577185cd7c674f0ec36efcc9c4970.png
10/22 20:31:25 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:25.785355761 +0900 JST m=+18.804953802 リクエストがタイムアウトしました (GET /css/bootstrap.min.css )
10/22 20:31:26 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:26.71856538 +0900 JST m=+19.738163423 リクエストがタイムアウトしました (GET /icons/846f4f0bde2a2103c71936091e82bc1354f11b3a.png )
10/22 20:31:27 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:27.787141271 +0900 JST m=+20.806738960 リクエストがタイムアウトしました (GET /icons/1ce0c4ff504f19f267e877a9e244d60ac0bf1a41.png )
10/22 20:31:28 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:28.625435613 +0900 JST m=+21.645033486 リクエストがタイムアウトしました (GET /fonts/glyphicons-halflings-regular.woff2 )
10/22 20:31:29 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:29.765467059 +0900 JST m=+22.785065172 リクエストがタイムアウトしました (GET /icons/78a9228a393eb2621f346fc6a5e099d5bc373f76.png )
10/22 20:31:30 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:30.780532521 +0900 JST m=+23.800130688 リクエストがタイムアウトしました (GET /icons/c2d161d74b4e6b6541974a473bf0a9dfb01579dd.png )
10/22 20:31:31 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:31.71392609 +0900 JST m=+24.733524147 リクエストがタイムアウトしました (GET /css/bootstrap.min.css )
10/22 20:31:32 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:32.780726962 +0900 JST m=+25.800324918 リクエストがタイムアウトしました (GET /icons/2716e8a567c6eb3bab842e5b82940e795583ce59.png )
10/22 20:31:33 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:33.766355763 +0900 JST m=+26.785953645 リクエストがタイムアウトしました (GET /icons/5dc48c74e0f923aa2a4acbe786d3cbe2512c6767.png )
10/22 20:31:34 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:34.666755592 +0900 JST m=+27.686353419 リクエストがタイムアウトしました (GET /icons/3f6591acbf1577185cd7c674f0ec36efcc9c4970.png )
10/22 20:31:35 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:35.761956226 +0900 JST m=+28.781553863 リクエストがタイムアウトしました (GET /icons/78a9228a393eb2621f346fc6a5e099d5bc373f76.png )
10/22 20:31:36 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:36.718759799 +0900 JST m=+29.738357626 リクエストがタイムアウトしました (GET /icons/b4f9effc4d9e86b58b271f5652b51dd997036d43.png )
10/22 20:31:37 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:37.787030109 +0900 JST m=+30.806628075 リクエストがタイムアウトしました (GET /icons/5e981ef46ec0f47bdc2f188673325b85078f5235.png )
10/22 20:31:38 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:38.751051364 +0900 JST m=+31.770649200 リクエストがタイムアウトしました (GET /icons/f906be69b742085556fd0d80ac1241e2693d9872.png )
10/22 20:31:39 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:39.78941158 +0900 JST m=+32.809009470 リクエストがタイムアウトしました (GET /icons/e7ae0e65a2deb1f89a1f82dfc713c787cf2a5233.png )
10/22 20:31:40 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:40.774572556 +0900 JST m=+33.794170693 リクエストがタイムアウトしました (GET /icons/b4f9effc4d9e86b58b271f5652b51dd997036d43.png )
10/22 20:31:41 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:41.793948968 +0900 JST m=+34.813546663 リクエストがタイムアウトしました (GET /icons/d9efb5732e0ee53618bd10d2ddc5a6b33edc4751.png )
10/22 20:31:42 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:42.781060042 +0900 JST m=+35.800657922 リクエストがタイムアウトしました (GET /icons/0614f0cea1b70fb71b4c3b88545a42327157a41e.jpg )
10/22 20:31:43 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:43.766663444 +0900 JST m=+36.786261186 リクエストがタイムアウトしました (GET /icons/3f6591acbf1577185cd7c674f0ec36efcc9c4970.png )
10/22 20:31:44 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:44.780307111 +0900 JST m=+37.799904954 リクエストがタイムアウトしました (GET /icons/c2d161d74b4e6b6541974a473bf0a9dfb01579dd.png )
10/22 20:31:45 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:45.756835101 +0900 JST m=+38.776433365 リクエストがタイムアウトしました (GET /icons/9152bd50720b3e825a7e193ff062e6fe13e72ef9.png )
10/22 20:31:46 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:46.771434312 +0900 JST m=+39.791032272 リクエストがタイムアウトしました (GET /icons/c2d161d74b4e6b6541974a473bf0a9dfb01579dd.png )
10/22 20:31:47 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:47.787174917 +0900 JST m=+40.806772987 リクエストがタイムアウトしました (GET /icons/5dc48c74e0f923aa2a4acbe786d3cbe2512c6767.png )
10/22 20:31:48 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:48.756646559 +0900 JST m=+41.776244510 リクエストがタイムアウトしました (GET /icons/851e9e15e1d1fff39c2d182881926d107154c44a.png )
10/22 20:31:49 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:49.74298328 +0900 JST m=+42.762581156 リクエストがタイムアウトしました (GET /icons/8628ef0f034d734729e3a735362e6008b30bb72b.png )
10/22 20:31:50 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:50.529530373 +0900 JST m=+43.549128235 リクエストがタイムアウトしました (GET /icons/c2d161d74b4e6b6541974a473bf0a9dfb01579dd.png )
10/22 20:31:51 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:51.703311372 +0900 JST m=+44.722909409 リクエストがタイムアウトしました (GET /icons/f0a6a8334e2b9b3f49c39ce35a19a2d20e648aab.png )
10/22 20:31:52 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:52.78133268 +0900 JST m=+45.800930606 リクエストがタイムアウトしました (GET /icons/ba05f8d186ab9c5270276176187eb0361b06baef.png )
10/22 20:31:53 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:53.767077919 +0900 JST m=+46.786676033 リクエストがタイムアウトしました (GET /icons/c2d161d74b4e6b6541974a473bf0a9dfb01579dd.png )
10/22 20:31:54 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:54.780589767 +0900 JST m=+47.800187723 リクエストがタイムアウトしました (GET /icons/f0a6a8334e2b9b3f49c39ce35a19a2d20e648aab.png )
10/22 20:31:55 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:55.757133767 +0900 JST m=+48.776731612 リクエストがタイムアウトしました (GET /icons/ba2d2384f825a83862f3b61302468b2e07f0a0f7.png )
10/22 20:31:56 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:56.785134774 +0900 JST m=+49.804732814 リクエストがタイムアウトしました (GET /icons/2716e8a567c6eb3bab842e5b82940e795583ce59.png )
10/22 20:31:57 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:57.787469233 +0900 JST m=+50.807067477 リクエストがタイムアウトしました (GET /icons/0614f0cea1b70fb71b4c3b88545a42327157a41e.jpg )
10/22 20:31:58 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:58.756872424 +0900 JST m=+51.776470087 リクエストがタイムアウトしました (GET /icons/bde120814720fb3bee14f415b4001305868df456.png )
10/22 20:31:59 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:31:59.762028044 +0900 JST m=+52.781625776 リクエストがタイムアウトしました (GET /icons/d9efb5732e0ee53618bd10d2ddc5a6b33edc4751.png )
10/22 20:32:00 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:32:00.754404185 +0900 JST m=+53.774002157 リクエストがタイムアウトしました (GET /icons/8628ef0f034d734729e3a735362e6008b30bb72b.png )
10/22 20:32:01 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:32:01.684441609 +0900 JST m=+54.704039476 リクエストがタイムアウトしました (GET /icons/f0a6a8334e2b9b3f49c39ce35a19a2d20e648aab.png )
10/22 20:32:02 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:32:02.775309928 +0900 JST m=+55.794907997 リクエストがタイムアウトしました (GET /fonts/glyphicons-halflings-regular.svg )
10/22 20:32:03 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:32:03.758459412 +0900 JST m=+56.778057368 リクエストがタイムアウトしました (GET /icons/78a9228a393eb2621f346fc6a5e099d5bc373f76.png )
10/22 20:32:04 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:32:04.728567089 +0900 JST m=+57.748165071 リクエストがタイムアウトしました (GET /icons/e7ae0e65a2deb1f89a1f82dfc713c787cf2a5233.png )
10/22 20:32:05 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:32:05.757394064 +0900 JST m=+58.776991715 リクエストがタイムアウトしました (GET /icons/1d7020c12548e0fa1401ade0dcd50591fbc709e3.png )
10/22 20:32:06 エラーが発生したため負荷レベルを上げられませんでした。2017-10-22 20:32:06.731756592 +0900 JST m=+59.751354390 リクエストがタイムアウトしました (GET /icons/e7ae0e65a2deb1f89a1f82dfc713c787cf2a5233.png )
```
